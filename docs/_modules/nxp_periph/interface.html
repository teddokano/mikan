<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>nxp_periph.interface &mdash; mikan 1.10 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            mikan
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">mikan</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">nxp_periph.interface</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for nxp_periph.interface</h1><div class="highlight"><pre>
<div class="viewcode-block" id="Interface"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.Interface">[docs]</a><span></span><span class="k">class</span> <span class="nc">Interface</span><span class="p">:</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	An abstraction class to provide common methods for devices</span>
<span class="sd">	&quot;&quot;&quot;</span>
<span class="c1">#	@classmethod</span>
<div class="viewcode-block" id="Interface.bit_operation"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.Interface.bit_operation">[docs]</a>	<span class="k">def</span> <span class="nf">bit_operation</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">target_bits</span><span class="p">,</span> <span class="n">value</span> <span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		register bit set/clear</span>
<span class="sd">	</span>
<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		reg : string or int</span>
<span class="sd">			Register name or register address/pointer.</span>
<span class="sd">		target_bits : int</span>
<span class="sd">			select target bits by setting its bit position 1</span>
<span class="sd">		value : int</span>
<span class="sd">			set/clear value.</span>
<span class="sd">			The bits only set/cleared with same position at</span>
<span class="sd">			1 in target_bits.</span>
<span class="sd">			</span>
<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		int : register value before modifying</span>
<span class="sd">		int : register value after modifying</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">reg</span>	<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">REG_NAME</span><span class="o">.</span><span class="n">index</span><span class="p">(</span> <span class="n">reg</span> <span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="n">reg</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span> <span class="k">else</span> <span class="n">reg</span>
		<span class="n">rv</span>	<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_registers</span><span class="p">(</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>
		<span class="n">wv</span>	<span class="o">=</span> <span class="n">rv</span>
		
		<span class="n">wv</span>	<span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">target_bits</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">value</span><span class="p">)</span>
		<span class="n">wv</span>	<span class="o">|=</span>  <span class="p">(</span><span class="n">target_bits</span> <span class="o">&amp;</span>  <span class="n">value</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">write_registers</span><span class="p">(</span> <span class="n">reg</span><span class="p">,</span> <span class="n">wv</span> <span class="p">)</span>
		
		<span class="k">return</span> <span class="n">rv</span><span class="p">,</span> <span class="n">wv</span></div>

<div class="viewcode-block" id="Interface.show_reg"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.Interface.show_reg">[docs]</a>	<span class="k">def</span> <span class="nf">show_reg</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">reg_name</span> <span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		showing register name, address/pointer and value</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		reg : string</span>
<span class="sd">			Register name</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">r</span>	<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">REG_NAME</span><span class="o">.</span><span class="n">index</span><span class="p">(</span> <span class="n">reg_name</span> <span class="p">)</span>
		<span class="n">rv</span>	<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_registers</span><span class="p">(</span> <span class="n">r</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>
		<span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">{:16}</span><span class="s2"> (0x</span><span class="si">{:02X}</span><span class="s2">) : 0x</span><span class="si">{:02X}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">reg_name</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rv</span> <span class="p">)</span> <span class="p">)</span></div>

<div class="viewcode-block" id="Interface.dump"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.Interface.dump">[docs]</a>	<span class="k">def</span> <span class="nf">dump</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		dump register values</span>
<span class="sd">	</span>
<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		list : register data</span>
<span class="sd">			List of integers</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_registers</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">REG_NAME</span> <span class="p">)</span> <span class="p">)</span></div>

<div class="viewcode-block" id="Interface.dump_reg"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.Interface.dump_reg">[docs]</a>	<span class="k">def</span> <span class="nf">dump_reg</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		showing all register name, address/pointer and value</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">rv</span>		<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>
		<span class="n">length</span>	<span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">rv</span> <span class="p">)</span>

		<span class="n">index</span>	<span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">length</span> <span class="p">)</span> <span class="p">]</span>
		<span class="n">reg</span>		<span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">REG_NAME</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span> <span class="p">]</span>
		<span class="n">rv</span>		<span class="o">=</span> <span class="p">[</span> <span class="n">rv</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span> <span class="p">]</span>
		<span class="n">lf</span>		<span class="o">=</span> <span class="p">[</span> <span class="p">{</span><span class="s2">&quot;end&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;end&quot;</span><span class="p">:</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">length</span> <span class="p">)</span> <span class="p">]</span>

		<span class="n">ml</span>		<span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="nb">max</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">REG_NAME</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="nb">len</span> <span class="p">)</span> <span class="p">)</span>
		<span class="n">fmt</span>		<span class="o">=</span> <span class="s2">&quot;    {{:</span><span class="si">{}</span><span class="s2">}}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">ml</span> <span class="p">)</span>
		<span class="n">fmt</span>	   <span class="o">+=</span> <span class="s2">&quot; (0x</span><span class="si">{:02X}</span><span class="s2">) : 0x</span><span class="si">{:02X}</span><span class="s2">&quot;</span>
		
		<span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;register dump: </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev_access</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span> <span class="n">reg</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">rv</span><span class="p">,</span> <span class="n">lf</span> <span class="p">):</span>
			<span class="nb">print</span><span class="p">(</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="p">),</span> <span class="o">**</span><span class="n">l</span> <span class="p">)</span>

		<span class="k">if</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">length</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;&quot;</span> <span class="p">)</span></div>

<div class="viewcode-block" id="Interface.info"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.Interface.info">[docs]</a>	<span class="k">def</span> <span class="nf">info</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		device information</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		string : device information</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="s2">&quot;an instance of </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev_access</span><span class="p">()</span> <span class="p">)</span></div>
	
<div class="viewcode-block" id="Interface.dev_access"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.Interface.dev_access">[docs]</a>	<span class="k">def</span> <span class="nf">dev_access</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		device access information</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		string : device access information</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;__adr&quot;</span> <span class="p">):</span>
			<span class="k">return</span> <span class="s2">&quot;target address 0x</span><span class="si">{:02X}</span><span class="s2"> (0x</span><span class="si">{:02X}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">__adr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__adr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="p">)</span>
		<span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;__cs&quot;</span> <span class="p">):</span>
			<span class="k">return</span> <span class="s2">&quot;cs_pin@</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cs</span> <span class="p">)</span></div></div>

<div class="viewcode-block" id="I2C_target_Error"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.I2C_target_Error">[docs]</a><span class="k">class</span> <span class="nc">I2C_target_Error</span><span class="p">(</span> <span class="ne">Exception</span> <span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Just a class for I2C exception handling</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">pass</span></div>

<div class="viewcode-block" id="I2C_target"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.I2C_target">[docs]</a><span class="k">class</span> <span class="nc">I2C_target</span><span class="p">(</span> <span class="n">Interface</span> <span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	An abstraction class to provide I2C device access.</span>
<span class="sd">	It helps to keep target address and communication.</span>
<span class="sd">	</span>
<span class="sd">	For register access methods, the register can be specified</span>
<span class="sd">	by its name or register address/pointer. </span>
<span class="sd">	The name of registers may needed to be defined as REG_NAME </span>
<span class="sd">	in inherited class (device class).</span>
<span class="sd">	</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">i2c</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">auto_increment_flag</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ignore_fail</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		I2C_target initializer</span>
<span class="sd">	</span>
<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		i2c : obj</span>
<span class="sd">			machine.I2C instance</span>
<span class="sd">		address : int</span>
<span class="sd">			I2C target (device) address</span>
<span class="sd">		auto_increment_flag : int</span>
<span class="sd">			On some devices, auto increment flag is needed for consecutive </span>
<span class="sd">			regiter access. This value is set in register address when </span>
<span class="sd">			multiple data sending. </span>
<span class="sd">		ignore_fail : bool</span>
<span class="sd">			Supress raising exception when transfer error (NACK) happned</span>
<span class="sd">			</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__adr</span>	<span class="o">=</span> <span class="n">address</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__if</span>	<span class="o">=</span> <span class="n">i2c</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__ai</span>	<span class="o">=</span> <span class="n">auto_increment_flag</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">ignore_fail</span>	<span class="o">=</span> <span class="n">ignore_fail</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">live</span>			<span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="I2C_target.ping"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.I2C_target.ping">[docs]</a>	<span class="k">def</span> <span class="nf">ping</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		ping for a device</span>
<span class="sd">		</span>
<span class="sd">		Access to the device with just its target address without data. </span>
<span class="sd">		If the device returned ACK, it keeps self.live=True. If device </span>
<span class="sd">		rturned NACK, the self.live is changed to False. </span>
<span class="sd">	</span>
<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		bool : Returns self.live</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">live</span>	<span class="o">=</span> <span class="kc">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span> <span class="p">[]</span> <span class="p">)</span>
		
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">live</span></div>

<div class="viewcode-block" id="I2C_target.send"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.I2C_target.send">[docs]</a>	<span class="k">def</span> <span class="nf">send</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">tsfr</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		send data (generate write transaction)</span>

<span class="sd">		Sending list-data to the device. </span>
<span class="sd">		It trys sending 3 times if the device respond NACK. </span>
<span class="sd">		If the device is kept not responding, the self.live is set to </span>
<span class="sd">		False to prevent further access to the failed device. </span>

<span class="sd">		Forcing self.live=True can re-live the device. </span>
<span class="sd">	</span>
<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		tsfr : list</span>
<span class="sd">			Data for sending. List of integers will be converted to</span>
<span class="sd">			bytearray before sending.</span>
<span class="sd">		stop : bool</span>
<span class="sd">			STOP-condition generated after the transaction.</span>
<span class="sd">			Use False to generate Repeated-START-condition on next</span>
<span class="sd">			transaction.</span>
<span class="sd">			</span>
<span class="sd">		&quot;&quot;&quot;</span>
		
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">live</span><span class="p">:</span>
			<span class="k">return</span>
			
		<span class="n">retry_setting</span>	<span class="o">=</span> <span class="n">retry</span>

		<span class="k">while</span> <span class="n">retry</span><span class="p">:</span>
			<span class="n">err</span>	<span class="o">=</span> <span class="kc">False</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">__if</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">__adr</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">(</span> <span class="n">tsfr</span> <span class="p">),</span> <span class="n">stop</span> <span class="p">)</span>
			<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
				<span class="n">err</span>		 <span class="o">=</span> <span class="kc">True</span>
				<span class="n">retry</span>	<span class="o">-=</span> <span class="mi">1</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">retry</span>	<span class="o">=</span> <span class="mi">0</span>
			
		<span class="k">if</span> <span class="p">(</span> <span class="n">err</span> <span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_fail</span><span class="p">:</span>
				<span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;I2C error: NACK returned </span><span class="si">{}</span><span class="s2"> times from </span><span class="si">{}</span><span class="s2">, address 0x</span><span class="si">{:02X}</span><span class="s2"> (0x</span><span class="si">{:02X}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">retry_setting</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__adr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__adr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">live</span>	<span class="o">=</span> <span class="kc">False</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">I2C_target_Error</span><span class="p">(</span> <span class="s2">&quot;I2C error: NACK returned </span><span class="si">{}</span><span class="s2"> times from </span><span class="si">{}</span><span class="s2">, address 0x</span><span class="si">{:02X}</span><span class="s2"> (0x</span><span class="si">{:02X}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">retry_setting</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__adr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__adr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span></div>

<div class="viewcode-block" id="I2C_target.receive"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.I2C_target.receive">[docs]</a>	<span class="k">def</span> <span class="nf">receive</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">barray</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		receive data (generate read transaction)</span>
<span class="sd">	</span>
<span class="sd">		Receiving list-data from the device. </span>
<span class="sd">		It trys receiving 3 times if the device respond NACK. </span>
<span class="sd">		If the device is kept not responding, the self.live is set to </span>
<span class="sd">		False to prevent further access to the failed device. </span>

<span class="sd">		Forcing self.live=True can re-live the device. </span>
<span class="sd">	</span>
<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		length : int</span>
<span class="sd">			Number of bytes for receiveing.</span>
<span class="sd">			</span>
<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		list : received data</span>
<span class="sd">			List of integers which was converted from bytearray.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">live</span><span class="p">:</span>
			<span class="k">return</span>
			
		<span class="n">retry_setting</span>	<span class="o">=</span> <span class="n">retry</span>

		<span class="k">while</span> <span class="n">retry</span><span class="p">:</span>
			<span class="n">err</span>	<span class="o">=</span> <span class="kc">False</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">rtn</span>	<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__if</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">__adr</span><span class="p">,</span> <span class="n">length</span> <span class="p">)</span>
			<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
				<span class="n">err</span>		 <span class="o">=</span> <span class="kc">True</span>
				<span class="n">retry</span>	<span class="o">-=</span> <span class="mi">1</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">retry</span>	<span class="o">=</span> <span class="mi">0</span>
			
		<span class="k">if</span> <span class="p">(</span> <span class="n">err</span> <span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_fail</span><span class="p">:</span>
				<span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;I2C error: NACK returned </span><span class="si">{}</span><span class="s2"> times from </span><span class="si">{}</span><span class="s2">, address 0x</span><span class="si">{:02X}</span><span class="s2"> (0x</span><span class="si">{:02X}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">retry_setting</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__adr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__adr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">live</span>	<span class="o">=</span> <span class="kc">False</span>
				<span class="n">rtn</span>			<span class="o">=</span> <span class="kc">None</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">I2C_target_Error</span><span class="p">(</span> <span class="s2">&quot;I2C error: NACK returned </span><span class="si">{}</span><span class="s2"> times from </span><span class="si">{}</span><span class="s2">, address 0x</span><span class="si">{:02X}</span><span class="s2"> (0x</span><span class="si">{:02X}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">retry_setting</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__adr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__adr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>

		<span class="k">if</span> <span class="n">barray</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">rtn</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="nb">list</span><span class="p">(</span> <span class="n">rtn</span> <span class="p">)</span></div>

<div class="viewcode-block" id="I2C_target.write_registers"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.I2C_target.write_registers">[docs]</a>	<span class="k">def</span> <span class="nf">write_registers</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span> <span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		writing registers</span>
<span class="sd">	</span>
<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		reg : string or int</span>
<span class="sd">			Register name or register address/pointer.</span>
<span class="sd">		data : list or int</span>
<span class="sd">			Data for sending.</span>
<span class="sd">			List for multibyte sending. List is converted to</span>
<span class="sd">			bytearray before sending.</span>
<span class="sd">			If the data is integer, single byte will be sent.</span>

<span class="sd">		Examples</span>
<span class="sd">		--------</span>
<span class="sd">		self.write_registers( &quot;PWM0&quot;, 0xFF ):		# single byte writing</span>
<span class="sd">		self.write_registers( &quot;PWM0&quot;, [0xFF] * 4 ):	# 4 bytes writing</span>
<span class="sd">		self.write_registers( 10, [0xFF] * 4 ):		# register specified by address</span>
<span class="sd">			</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1">#print( &quot;I2C write_registers: {}, {}&quot;.format( reg, data ) )</span>
		
		<span class="n">reg</span>		<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">REG_NAME</span><span class="o">.</span><span class="n">index</span><span class="p">(</span> <span class="n">reg</span> <span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="n">reg</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span> <span class="k">else</span> <span class="n">reg</span>
		
		<span class="k">if</span> <span class="p">(</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span> <span class="p">):</span>
			<span class="k">pass</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">reg</span>	   <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ai</span>
		
		<span class="n">data</span>	<span class="o">=</span> <span class="p">[</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span> <span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="k">else</span> <span class="p">[</span> <span class="n">reg</span> <span class="p">]</span> <span class="o">+</span> <span class="n">data</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">)</span></div>
		
<div class="viewcode-block" id="I2C_target.read_registers"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.I2C_target.read_registers">[docs]</a>	<span class="k">def</span> <span class="nf">read_registers</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">repeated_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">barray</span> <span class="o">=</span> <span class="kc">False</span>  <span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		reading registers</span>
<span class="sd">	</span>
<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		reg : string or int</span>
<span class="sd">			Register name or register address/pointer.</span>
<span class="sd">		length : int</span>
<span class="sd">			Number of bytes for receiveing.</span>
<span class="sd">		repeated_start : bool, option</span>
<span class="sd">			If True, a Repeated-START-condition generated between</span>
<span class="sd">			write and read transactions.</span>
<span class="sd">			If False, a STOP-condition and START-condition are</span>
<span class="sd">			generated between write and read transactions.</span>

<span class="sd">		Examples</span>
<span class="sd">		--------</span>
<span class="sd">		data = self.read_registers( &quot;PWM0&quot;, 1 ):	# single byte reading, returns an int</span>
<span class="sd">		data = self.read_registers( &quot;PWM0&quot;, 4 ):	# 4 bytes reading, returns a list</span>
<span class="sd">		data = self.read_registers( 10, 4 ):		# register specified by address</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1">#print( &quot;I2C read_registers: {}, {}&quot;.format( reg, data ) )</span>

		<span class="n">reg</span>	<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">REG_NAME</span><span class="o">.</span><span class="n">index</span><span class="p">(</span> <span class="n">reg</span> <span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="n">reg</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span> <span class="k">else</span> <span class="n">reg</span>

		<span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">reg</span>	   <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ai</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span> <span class="p">[</span> <span class="n">reg</span> <span class="p">],</span> <span class="n">stop</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">repeated_start</span> <span class="p">)</span>
		<span class="n">r</span>	<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span> <span class="n">length</span><span class="p">,</span> <span class="n">barray</span> <span class="o">=</span> <span class="n">barray</span> <span class="p">)</span>
		
		<span class="k">return</span>	<span class="n">r</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">r</span></div></div>

<div class="viewcode-block" id="SPI_target"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.SPI_target">[docs]</a><span class="k">class</span> <span class="nc">SPI_target</span><span class="p">(</span> <span class="n">Interface</span> <span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	An abstraction class to provide SPI device access.</span>
<span class="sd">	It helps to keep target access method and communication.</span>
<span class="sd">	</span>
<span class="sd">	For register access methods, the register can be specified</span>
<span class="sd">	by its name or register address/pointer. </span>
<span class="sd">	The name of registers may needed to be defined as REG_NAME </span>
<span class="sd">	in inherited class (device class).</span>
<span class="sd">	</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">spi</span><span class="p">,</span> <span class="n">cs</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		SPI_target initializer</span>
<span class="sd">		</span>
<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		spi : obj</span>
<span class="sd">			machine.SPI instance</span>
<span class="sd">		cs : obj</span>
<span class="sd">			machine.Pin instance (Chip select output)</span>
<span class="sd">			This &#39;cs&#39; can be None in case of using hardware </span>
<span class="sd">			controlledChipSelect signal</span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__cs</span>	<span class="o">=</span> <span class="n">cs</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__if</span>	<span class="o">=</span> <span class="n">spi</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">chip_select</span>	<span class="o">=</span> <span class="mi">1</span>

<div class="viewcode-block" id="SPI_target.send"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.SPI_target.send">[docs]</a>	<span class="k">def</span> <span class="nf">send</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">data</span> <span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		send data (generate write transaction)</span>
<span class="sd">	</span>
<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		tsfr : list</span>
<span class="sd">			Data for sending. List of integers will be converted to</span>
<span class="sd">			bytearray before sending.</span>
<span class="sd">			</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">chip_select</span>	<span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__if</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="nb">bytearray</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span> <span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">chip_select</span>	<span class="o">=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="SPI_target.receive"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.SPI_target.receive">[docs]</a>	<span class="k">def</span> <span class="nf">receive</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">tsfr</span> <span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		receive data (generate write &amp; read transaction)</span>
<span class="sd">	</span>
<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		tsfr : list</span>
<span class="sd">			Data for sending. List of integers will be converted to</span>
<span class="sd">			bytearray before sending.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		list : received data</span>
<span class="sd">			List of integers which was converted from bytearray.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">tsfr</span>	<span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span> <span class="n">tsfr</span> <span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">chip_select</span>	<span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__if</span><span class="o">.</span><span class="n">write_readinto</span><span class="p">(</span> <span class="n">tsfr</span><span class="p">,</span> <span class="n">tsfr</span> <span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">chip_select</span>	<span class="o">=</span> <span class="mi">1</span>
		
		<span class="k">return</span> <span class="nb">list</span><span class="p">(</span> <span class="n">tsfr</span> <span class="p">)</span></div>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">chip_select</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
		<span class="k">pass</span>

	<span class="nd">@chip_select</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">chip_select</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span> <span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		A setter method to perform CS signal HIGH/LOW by assignment</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cs</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">__cs</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="n">v</span> <span class="p">)</span>

<div class="viewcode-block" id="SPI_target.write_registers"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.SPI_target.write_registers">[docs]</a>	<span class="k">def</span> <span class="nf">write_registers</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span> <span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		writing registers</span>
<span class="sd">	</span>
<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		reg : string or int</span>
<span class="sd">			Register name or register address/pointer.</span>
<span class="sd">		data : list or int</span>
<span class="sd">			Data for sending.</span>
<span class="sd">			List for multibyte sending. List is converted to</span>
<span class="sd">			bytearray before sending.</span>
<span class="sd">			If the data is integer, single byte will be sent.</span>
<span class="sd">			</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1">#print( &quot;SPI write_registers: {}, {}&quot;.format( reg, data ) )</span>
		
		<span class="n">reg</span>		<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">REG_NAME</span><span class="o">.</span><span class="n">index</span><span class="p">(</span> <span class="n">reg</span> <span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="n">reg</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span> <span class="k">else</span> <span class="n">reg</span>
		<span class="n">data</span>	<span class="o">=</span> <span class="p">[</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span> <span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="k">else</span> <span class="p">[</span> <span class="n">reg</span> <span class="p">]</span> <span class="o">+</span> <span class="n">data</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span></div>
		
<div class="viewcode-block" id="SPI_target.read_registers"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.SPI_target.read_registers">[docs]</a>	<span class="k">def</span> <span class="nf">read_registers</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">length</span> <span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		reading registers</span>
<span class="sd">	</span>
<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		reg : string or int</span>
<span class="sd">			Register name or register address/pointer.</span>
<span class="sd">		length : int</span>
<span class="sd">			Number of bytes for receiveing.</span>
<span class="sd">		repeated_start : bool, option</span>
<span class="sd">			If True, a Repeated-START-condition generated between</span>
<span class="sd">			write and read transactions.</span>
<span class="sd">			If False, a STOP-condition and START-condition are</span>
<span class="sd">			generated between write and read transactions.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1">#print( &quot;SPI read_registers: {}, {}&quot;.format( reg, length ) )</span>
		
		<span class="n">reg</span>		 <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">REG_NAME</span><span class="o">.</span><span class="n">index</span><span class="p">(</span> <span class="n">reg</span> <span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="n">reg</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span> <span class="k">else</span> <span class="n">reg</span>
		<span class="n">data</span>	 <span class="o">=</span> <span class="p">[</span><span class="n">reg</span> <span class="o">|</span> <span class="mh">0x80</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span> <span class="mh">0x00</span> <span class="p">]</span> <span class="o">*</span> <span class="n">length</span>

		<span class="n">r</span>	<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span>

		<span class="k">return</span> <span class="n">r</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="k">if</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">length</span> <span class="k">else</span> <span class="n">r</span><span class="p">[</span> <span class="mi">1</span><span class="p">:</span> <span class="p">]</span></div></div>

<div class="viewcode-block" id="abstract_target"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.abstract_target">[docs]</a><span class="k">class</span> <span class="nc">abstract_target</span><span class="p">(</span> <span class="n">Interface</span> <span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	An abstraction class for off-line test.</span>
<span class="sd">	No physical access will be performed with this class. </span>
<span class="sd">	&quot;&quot;&quot;</span>

<div class="viewcode-block" id="abstract_target.send"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.abstract_target.send">[docs]</a>	<span class="k">def</span> <span class="nf">send</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">tsfr</span> <span class="p">):</span>
		<span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;send: &quot;</span><span class="p">,</span> <span class="n">tsfr</span> <span class="p">)</span></div>

<div class="viewcode-block" id="abstract_target.receive"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.abstract_target.receive">[docs]</a>	<span class="k">def</span> <span class="nf">receive</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">length</span> <span class="p">):</span>
		<span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;receive: &quot;</span><span class="p">,</span> <span class="n">length</span> <span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="abstract_target.write_registers"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.abstract_target.write_registers">[docs]</a>	<span class="k">def</span> <span class="nf">write_registers</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span> <span class="p">):</span>
		<span class="n">reg</span>		<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">REG_NAME</span><span class="o">.</span><span class="n">index</span><span class="p">(</span> <span class="n">reg</span> <span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="n">reg</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span> <span class="k">else</span> <span class="n">reg</span>
		<span class="n">data</span>	<span class="o">=</span> <span class="p">[</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span> <span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="k">else</span> <span class="p">[</span> <span class="n">reg</span> <span class="p">]</span> <span class="o">+</span> <span class="n">data</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span></div>
		
<div class="viewcode-block" id="abstract_target.read_registers"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.abstract_target.read_registers">[docs]</a>	<span class="k">def</span> <span class="nf">read_registers</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">repeated_start</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">):</span>
		<span class="n">reg</span>	<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">REG_NAME</span><span class="o">.</span><span class="n">index</span><span class="p">(</span> <span class="n">reg</span> <span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="n">reg</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span> <span class="k">else</span> <span class="n">reg</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span> <span class="p">[</span> <span class="n">reg</span> <span class="p">],</span> <span class="n">stop</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">repeated_start</span> <span class="p">)</span>
		<span class="n">r</span>	<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span> <span class="n">length</span> <span class="p">)</span>
		
		<span class="k">return</span>	<span class="n">r</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">r</span></div></div>

<div class="viewcode-block" id="i2c_fullscan"><a class="viewcode-back" href="../../nxp_periph.html#nxp_periph.interface.i2c_fullscan">[docs]</a><span class="k">def</span> <span class="nf">i2c_fullscan</span><span class="p">(</span> <span class="n">i2c</span> <span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	I2C scan for full range of target addresses. </span>
<span class="sd">	Because the machine.I2C.scan() does scan is limited in range of 0x08(0x10) </span>
<span class="sd">	to 0x77(0xEE). </span>
<span class="sd">	</span>
<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	i2c : obj</span>
<span class="sd">		machine.I2C instance</span>
<span class="sd">		</span>
<span class="sd">	Returns</span>
<span class="sd">	-------</span>
<span class="sd">	list : Responding target ddress list</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="nb">list</span>	<span class="o">=</span> <span class="p">[]</span>
	<span class="n">data</span>	<span class="o">=</span> <span class="p">[]</span>
	
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">128</span> <span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">i2c</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span> <span class="n">i</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span> <span class="p">)</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
			<span class="k">pass</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="nb">list</span>	<span class="o">+=</span> <span class="p">[</span> <span class="n">i</span> <span class="p">]</span>
			
	<span class="k">return</span> <span class="nb">list</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Tedd OKANO.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>